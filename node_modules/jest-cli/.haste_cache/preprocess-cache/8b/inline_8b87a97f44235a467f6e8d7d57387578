'use strict';










var t=require('babel-core').types;

var react={name:'React'};
var platform={name:'Platform'};
var os={name:'OS'};
var requirePattern={name:'require'};

var env={name:'env'};
var nodeEnv={name:'NODE_ENV'};
var processId={name:'process'};

var dev={name:'__DEV__'};

var isGlobal=function(binding){return !binding;};

var isToplevelBinding=function(binding){return isGlobal(binding)||!binding.scope.parent;};

var isRequireCall=function(node,dependencyId,scope){return (
t.isCallExpression(node)&&
t.isIdentifier(node.callee,requirePattern)&&
t.isStringLiteral(node.arguments[0],t.stringLiteral(dependencyId)));};

var isImport=function(node,scope,pattern){return (
t.isIdentifier(node,pattern)&&
isToplevelBinding(scope.getBinding(pattern.name))||
isRequireCall(node,pattern.name,scope));};

var isPlatformOS=function(node,scope){return (
t.isIdentifier(node.property,os)&&
isImport(node.object,scope,platform));};

var isReactPlatformOS=function(node,scope){return (
t.isIdentifier(node.property,os)&&
t.isMemberExpression(node.object)&&
t.isIdentifier(node.object.property,platform)&&
isImport(node.object.object,scope,react));};

var isProcessEnvNodeEnv=function(node,scope){return (
t.isIdentifier(node.property,nodeEnv)&&
t.isMemberExpression(node.object)&&
t.isIdentifier(node.object.property,env)&&
t.isIdentifier(node.object.object,processId)&&
isGlobal(scope.getBinding(processId.name)));};

var isDev=function(node,parent,scope){return (
t.isIdentifier(node,dev)&&
isGlobal(scope.getBinding(dev.name))&&
!t.isMemberExpression(parent));};

var inlinePlugin={
visitor:{
Identifier:function(path,state){
if(isDev(path.node,path.parent,path.scope)){
path.replaceWith(t.booleanLiteral(state.opts.dev));}},


MemberExpression:function(path,state){
var node=path.node;
var scope=path.scope;

if(isPlatformOS(node,scope)||isReactPlatformOS(node,scope)){
path.replaceWith(t.stringLiteral(state.opts.platform));}


if(isProcessEnvNodeEnv(node,scope)){
path.replaceWith(
t.stringLiteral(state.opts.dev?'development':'production'));}}}};





var plugin=function(){return inlinePlugin;};

function inline(filename,transformResult,options){
var code=transformResult.code;
var babelOptions={
filename:filename,
plugins:[[plugin,options]],
inputSourceMap:transformResult.map,
sourceMaps:true,
sourceFileName:filename,
code:false,
babelrc:false,
compact:true};


return transformResult.ast?
require('babel-core').transformFromAst(transformResult.ast,code,babelOptions):
require('babel-core').transform(code,babelOptions);}


module.exports=inline;